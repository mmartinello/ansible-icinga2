---
- set_fact:
    icinga2_client_configured: true
  when: icinga2_client_file.stat.exists == True
  tags: ['configure-client']

- name: Check if satellite is already configured on Icinga server
  stat:
    path: /root/.icinga2_client_configured
  register: icinga2_client_file
  when: ansible_system == "Linux"
  tags: ['configure-client']

# FIXME: adapt for Windows  
#- name: Check if satellite is already configured on Icinga server
#  stat:
#    path: /root/.icinga2_client_configured
#  register: icinga2_client_file
#  when: ansible_os_family == "Windows"
#  tags: ['configure-client']

- set_fact:
    icinga2_client_configured: true
  when: icinga2_client_file.stat.exists == True and icinga2_client_reinstall == False
  tags: ['configure-client']

- name: Generate a new key and CSR for new satellite on icinga server
  shell: cd /tmp && icinga2 pki new-cert --cn {{ inventory_hostname }} --key /tmp/{{ inventory_hostname }}.key --csr /tmp/{{ inventory_hostname 
  delegate_to: "{{ icinga2_master_inventory_hostname }}"
  when: icinga2_client_configured == False
  tags: ['configure-client']

- name: Sign the certificate with the master CA certificate on the master node
  shell: icinga2 pki sign-csr --csr /tmp/{{ inventory_hostname }}.csr --cert /tmp/{{ inventory_hostname }}.crt
  delegate_to: "{{ icinga2_master_inventory_hostname }}"
  when: icinga2_client_configured == False
  tags: ['configure-client']

- name: Download the CA certificate from Icinga master node
  fetch:
    src: /var/lib/icinga2/ca/ca.crt
    dest: "/tmp/ansible/{{ inventory_hostname }}/icinga/ca.crt"
    flat: yes
  delegate_to: "{{ icinga2_master_inventory_hostname }}"
  when: icinga2_client_configured == False
  tags: ['configure-client']

- name: Get files to be downloaded
  shell: "ls /tmp/{{ inventory_hostname }}.*"
  register: files_to_be_downloaded
  delegate_to: "{{ icinga2_master_inventory_hostname }}"
  when: icinga2_client_configured == False
  tags: ['configure-client']

- name: Download certificates from Icinga master node
  fetch:
    src: "{{item}}"
    dest: "/tmp/ansible/{{ inventory_hostname }}/icinga/"   
    flat: yes
  with_items: "{{ files_to_be_downloaded.stdout_lines }}" 
  delegate_to: "{{ icinga2_master_inventory_hostname }}"
  when: icinga2_client_configured == False
  tags: ['configure-client']

- name: Delete temporary files from Icinga master node
  file:
    path: "/tmp/{{ inventory_hostname }}.*"
    state: absent
  delegate_to: "{{ icinga2_master_inventory_hostname }}"
  when: icinga2_client_configured == False
  tags: ['configure-client']
  
- include_tasks: client-configure-Linux.yml
  when: ansible_system == "Linux"
  tags: ['configure-client']

- include_tasks: client-configure-Windows.yml
  when: ansible_os_family == "Windows"
  tags: ['configure-client']

- name: Delete temporary files from Ansible host
  local_action:
    module: file
    path: "/tmp/ansible/{{ inventory_hostname }}"
    state: absent
  when: icinga2_client_configured == False
  tags: ['configure-client']

- name: Configure the client file on Icinga master server
  vars:
    client_ip_address: "{{ ansible_default_ipv4.address }}"
    client_os: "{{ ansible_system }}"
    client_distro: "{{ ansible_distribution }}"
  template:
    src: client-host.conf.j2
    dest: "{{ config_root_dir }}/zones.d/{{ icinga2_master_host }}/{{ inventory_hostname }}.conf"
    owner: root
    group: root
    mode: 0644
  delegate_to: "{{ icinga2_master_inventory_hostname }}"
  notify: Reload Icinga on master server
  tags: ['configure-client']

- name: Create the client configuration state file
  file:
    path: /root/.icinga2_client_configured
    state: touch
  when: icinga2_client_configured == False and ansible_system == "Linux"
  tags: ['configure-client']

# FIXME: adapt for Windows
#- name: Create the client configuration state file
#  file:
#    path: /root/.icinga2_client_configured
#    state: touch
#  when: icinga2_client_configured == False and ansible_os_family == "Windows"
#  tags: ['configure-client']
